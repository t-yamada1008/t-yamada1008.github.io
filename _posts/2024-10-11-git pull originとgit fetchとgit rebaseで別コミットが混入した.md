---
layout: post
title: git pull originとgit fetchとgit rebaseで別コミットが混入した
date: 2024-10-11
categories: [TIL]
tags: [ruby, rails, gpt]
---

## 今日のやらかし
最終的にはベースブランチを再度pullしてcheckoutしてcherry-pickした。

**【原因】**

1. **Fetch 設定による PR の取得**:
   - リポジトリの `.git/config` ファイルで、`fetch` の設定に `refs/pull/*` が含まれている場合、`git fetch` 時に PR のリファレンスも取得してしまいます。
   - その結果、`git pull` や `git rebase` の際に、PR のコミットが混入する可能性があります。

2. **マージ先のブランチの指定ミス**:
   - `git pull origin` コマンドを実行する際、デフォルトのブランチではなく別のブランチ（例えば PR ブランチ）を引き込んでしまうことがあります。
   - リモートリポジトリのデフォルトブランチが変更されていたり、追跡ブランチの設定が誤っていると、意図しないコミットが混入します。

3. **リベース先の誤り**:
   - `git rebase` を行う際に、誤ったブランチを指定すると、不要なコミットが取り込まれる可能性があります。

---

**【解決法】**

1. **混入したコミットを除去する**:
   - **リセット**:
     - `git log` や `git reflog` を使って、PR が混入する前の正しいコミットを確認します。
     - `git reset --hard <コミットハッシュ>` でブランチを正しい状態に戻します。
     - ※注意: `--hard` オプションは作業ツリーの変更も破棄しますので、未コミットの変更がある場合は事前にバックアップしてください。

2. **Fetch 設定の確認と修正**:
   - `.git/config` ファイルを開き、`[remote "origin"]` セクションを確認します。
   - `fetch = +refs/heads/*:refs/remotes/origin/*` のみが設定されているか確認し、もし `refs/pull/*` が含まれていれば削除します。

3. **リモートブランチの整理**:
   - `git remote prune origin` を実行して、存在しないリモート追跡ブランチを削除します。

4. **正しいブランチを指定して操作する**:
   - **git pull の際にブランチを明示**:
     - `git pull origin <ブランチ名>` のように、明示的にブランチを指定します。
   - **git rebase の際にリモートブランチを指定**:
     - `git rebase origin/<ブランチ名>` で正しいブランチを基点にリベースします。

5. **ブランチの追跡設定を確認**:
   - `git branch -vv` コマンドで、各ブランチがどのリモートブランチを追跡しているか確認します。
   - 必要に応じて、`git branch --set-upstream-to=origin/<ブランチ名>` で正しい追跡設定を行います。

---

**【対処】**

- **設定の見直し**:
  - 不要な fetch 設定を削除し、必要最低限のリファレンスのみを取得するようにします。
- **操作手順の徹底**:
  - コマンド実行時には、常に対象のブランチを明示的に指定します。
- **チーム内での共有**:
  - 同様の問題が起きないように、チームメンバーと情報を共有し、共通の運用ルールを策定します。
- **定期的なメンテナンス**:
  - リモートリポジトリの変更に応じて、ローカルリポジトリの設定やブランチを整理します。

---

**【まとめ】**

- PR のコミットが混入する原因は、fetch 設定やブランチ指定のミスによるものです。
- 解決策として、設定ファイルの見直しや正しいブランチの指定、混入したコミットの除去が挙げられます。
- 今後は操作手順を徹底し、設定を適切に管理することで、同様の問題を防ぐことができます。
